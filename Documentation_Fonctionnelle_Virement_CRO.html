<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentation Fonctionnelle - Syst√®me de Virement SMILE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
            border-radius: 10px 10px 0 0;
            margin: -20px -20px 30px -20px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .toc {
            background-color: #f8f9fa;
            border-left: 4px solid #2a5298;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
        }

        .toc h2 {
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .toc ul {
            list-style: none;
        }

        .toc ul li {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .toc ul li:last-child {
            border-bottom: none;
        }

        .toc a {
            color: #2a5298;
            text-decoration: none;
            transition: all 0.3s;
        }

        .toc a:hover {
            color: #1e3c72;
            padding-left: 10px;
        }

        section {
            margin-bottom: 50px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        h2 {
            color: #1e3c72;
            font-size: 2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #2a5298;
        }

        h3 {
            color: #2a5298;
            font-size: 1.5em;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        h4 {
            color: #4a6fa5;
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .type-virement {
            background-color: #e8f4f8;
            border-left: 4px solid #2a5298;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .type-virement h4 {
            color: #1e3c72;
            margin-top: 0;
        }

        .caracteristiques {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .caracteristique-item {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #d0e4f2;
        }

        .caracteristique-item strong {
            color: #2a5298;
            display: block;
            margin-bottom: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        thead {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
            transition: background-color 0.3s;
        }

        .code-block {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .code-block .keyword {
            color: #66d9ef;
        }

        .code-block .string {
            color: #a6e22e;
        }

        .code-block .comment {
            color: #75715e;
            font-style: italic;
        }

        .flowchart {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            border: 2px solid #e0e0e0;
        }

        .flowchart-step {
            background-color: white;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #2a5298;
            border-radius: 3px;
            position: relative;
        }

        .flowchart-step::before {
            content: '‚ñº';
            position: absolute;
            left: -2px;
            bottom: -20px;
            color: #2a5298;
            font-size: 1.2em;
        }

        .flowchart-step:last-child::before {
            content: '';
        }

        .flowchart-step h5 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }

        .alert-info {
            background-color: #d1ecf1;
            border-color: #0c5460;
            color: #0c5460;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-color: #856404;
            color: #856404;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #155724;
            color: #155724;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-primary {
            background-color: #2a5298;
            color: white;
        }

        .badge-success {
            background-color: #28a745;
            color: white;
        }

        .badge-danger {
            background-color: #dc3545;
            color: white;
        }

        .badge-warning {
            background-color: #ffc107;
            color: #333;
        }

        .file-path {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-left: 3px solid #28a745;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border-radius: 3px;
        }

        .file-path::before {
            content: 'üìÅ ';
            margin-right: 5px;
        }

        ul, ol {
            margin-left: 30px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        li {
            margin: 8px 0;
        }

        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .card h4 {
            color: #1e3c72;
            margin-top: 0;
        }

        footer {
            background-color: #1e3c72;
            color: white;
            text-align: center;
            padding: 20px;
            margin: 50px -20px -20px -20px;
            border-radius: 0 0 10px 10px;
        }

        @media print {
            body {
                background-color: white;
            }

            .container {
                box-shadow: none;
            }

            section {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìã Documentation Fonctionnelle</h1>
            <p>Syst√®me de Gestion des Virements - Application SMILE BNA</p>
            <p style="font-size: 0.9em; margin-top: 10px;">Focus: CRO (Comptes Rendus d'Op√©ration) et Traitements</p>
        </header>

        <div class="toc">
            <h2>üìë Table des Mati√®res</h2>
            <ul>
                <li><a href="#section1">1. Vue d'Ensemble du Syst√®me de Virement</a></li>
                <li><a href="#section2">2. Types de Virements</a></li>
                <li><a href="#section3">3. Architecture des CRO (Comptes Rendus d'Op√©ration)</a></li>
                <li><a href="#section4">4. Traitements de Virement</a></li>
                <li><a href="#section5">5. Flux de Traitement Complet</a></li>
                <li><a href="#section6">6. Validations et Contr√¥les</a></li>
                <li><a href="#section7">7. Gestion des Rejets</a></li>
                <li><a href="#section8">8. Interactions avec les Modules</a></li>
                <li><a href="#section9">9. Tables de Base de Donn√©es</a></li>
                <li><a href="#section10">10. √âtats et Transitions</a></li>
            </ul>
        </div>

        <section id="section1">
            <h2>1. Vue d'Ensemble du Syst√®me de Virement</h2>

            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Contexte:</strong> Le syst√®me SMILE (Syst√®me de Management Int√©gr√© Local et √âtendu) de la BNA g√®re l'ensemble des op√©rations de virements bancaires, depuis la saisie par les agents jusqu'√† l'ex√©cution et la comptabilisation, en passant par de multiples contr√¥les et validations.
            </div>

            <h3>1.1 Architecture Globale</h3>
            <p>Le syst√®me de virement s'articule autour de trois composantes principales:</p>

            <div class="grid-2col">
                <div class="card">
                    <h4>üñ•Ô∏è Couche Pr√©sentation (Web)</h4>
                    <div class="file-path">smile/web/virement/controller/</div>
                    <ul>
                        <li>PecVirementPonctuelCtr.java</li>
                        <li>PecVirementPermanentCtr.java</li>
                        <li>PecVirementMasseCtr.java</li>
                        <li>PecVirementDeviseCtr.java</li>
                        <li>PecVirementCentralCtr.java</li>
                        <li>ExecutionVirementCtr.java</li>
                    </ul>
                </div>

                <div class="card">
                    <h4>‚öôÔ∏è Couche Traitement (Model)</h4>
                    <div class="file-path">smile/model/virement/traitement/</div>
                    <ul>
                        <li>SaveGlobalVirementTrt.java</li>
                        <li>ExecutionDoVirPonctuelTrt.java</li>
                        <li>TraiterExecutionVirPermanentTrt.java</li>
                        <li>CreationCRO*.java (18 classes CRO)</li>
                        <li>ValidationVirementCarteSalairesTrt.java</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h4>üíæ Couche Donn√©es (Entit√©s)</h4>
                <div class="file-path">commun/model/</div>
                <ul>
                    <li><strong>GlobalVirement:</strong> Entit√© principale repr√©sentant un ordre de virement global</li>
                    <li><strong>DetailVirement:</strong> D√©tails de chaque b√©n√©ficiaire</li>
                    <li><strong>OperationMoyPay:</strong> Op√©ration comptable g√©n√©r√©e</li>
                    <li><strong>TraceVirement:</strong> Tra√ßabilit√© des flux de virements</li>
                    <li><strong>DetailsOperationVirement:</strong> D√©tails financiers (commissions, TVA)</li>
                </ul>
            </div>

            <h3>1.2 Principes de Fonctionnement</h3>

            <div class="flowchart">
                <div class="flowchart-step">
                    <h5>Phase 1: Saisie et Validation</h5>
                    <p>L'agent saisit les informations du virement via l'interface web. Le syst√®me effectue des validations en temps r√©el (RIB, provision, pouvoir).</p>
                </div>

                <div class="flowchart-step">
                    <h5>Phase 2: Cr√©ation et Sauvegarde</h5>
                    <p>Cr√©ation du GlobalVirement avec g√©n√©ration d'un num√©ro de remise unique. Sauvegarde des DetailVirement associ√©s.</p>
                </div>

                <div class="flowchart-step">
                    <h5>Phase 3: Ex√©cution</h5>
                    <p>Traitement batch ou manuel qui d√©bite le compte donneur d'ordre et g√©n√®re les CRO appropri√©s selon la destination.</p>
                </div>

                <div class="flowchart-step">
                    <h5>Phase 4: Positionnement B√©n√©ficiaire</h5>
                    <p>Pour les virements BNA, cr√©dit imm√©diat du compte b√©n√©ficiaire. Pour les autres banques, g√©n√©ration de fichiers SIBTEL ou SGMT.</p>
                </div>
            </div>
        </section>

        <section id="section2">
            <h2>2. Types de Virements</h2>

            <p>Le syst√®me SMILE g√®re 7 types principaux de virements, chacun avec ses caract√©ristiques et traitements sp√©cifiques.</p>

            <div class="type-virement">
                <h4>2.1 Virement Ponctuel <span class="badge badge-primary">COD_PRD_VIR_PONCTUEL = 1063</span></h4>
                <p><strong>Description:</strong> Virement unique ex√©cut√© une seule fois √† la date demand√©e.</p>

                <div class="caracteristiques">
                    <div class="caracteristique-item">
                        <strong>Classe Contr√¥leur:</strong>
                        PecVirementPonctuelCtr.java
                    </div>
                    <div class="caracteristique-item">
                        <strong>Traitement Ex√©cution:</strong>
                        ExecutionDoVirPonctuelTrt.java
                    </div>
                    <div class="caracteristique-item">
                        <strong>CRO Principal:</strong>
                        CreationCROExecutionVirementPonctuelTrt (715)
                    </div>
                    <div class="caracteristique-item">
                        <strong>√âtat Initial:</strong>
                        ATTENTE (0)
                    </div>
                </div>

                <h5>Caract√©ristiques Sp√©cifiques:</h5>
                <ul>
                    <li>Peut avoir un ou plusieurs b√©n√©ficiaires</li>
                    <li>Date d'ex√©cution modifiable tant que non ex√©cut√©</li>
                    <li>Peut √™tre annul√© avant ex√©cution</li>
                    <li>G√©n√®re un num√©ro de remise unique: [CodeStructure][Ann√©e][S√©quence]</li>
                </ul>

                <div class="alert alert-info">
                    <strong>Exemple:</strong> Un client souhaite effectuer un virement unique de 5 000 TND vers un b√©n√©ficiaire pour r√®glement d'une facture.
                </div>
            </div>

            <div class="type-virement">
                <h4>2.2 Virement Permanent <span class="badge badge-primary">COD_PRD_VIR_PERMANENT = 1064</span></h4>
                <p><strong>Description:</strong> Virement r√©current avec p√©riodicit√© d√©finie (mensuelle, trimestrielle, semestrielle, annuelle).</p>

                <div class="caracteristiques">
                    <div class="caracteristique-item">
                        <strong>Classe Contr√¥leur:</strong>
                        PecVirementPermanentCtr.java
                    </div>
                    <div class="caracteristique-item">
                        <strong>Traitement Ex√©cution:</strong>
                        TraiterExecutionVirPermanentTrt.java
                    </div>
                    <div class="caracteristique-item">
                        <strong>CRO Principal:</strong>
                        CreationCROExecutionVirementPermanentTrt (716)
                    </div>
                    <div class="caracteristique-item">
                        <strong>√âtat Transitoire:</strong>
                        ENCOUREXECUTION (5)
                    </div>
                </div>

                <h5>Attributs Sp√©cifiques:</h5>
                <ul>
                    <li><strong>periodiciteGvir:</strong> P√©riodicit√© (M=Mensuelle, T=Trimestrielle, S=Semestrielle, A=Annuelle)</li>
                    <li><strong>datFinEch:</strong> Date de fin des √©ch√©ances</li>
                    <li>Chaque DetailVirement poss√®de une <strong>datEchDetv</strong> (date √©ch√©ance)</li>
                    <li>Ex√©cution automatique par batch quotidien</li>
                </ul>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Important:</strong> Un virement permanent reste en √©tat ENCOUREXECUTION tant que des √©ch√©ances futures existent. Il passe √† EXECUTER uniquement quand toutes les √©ch√©ances sont trait√©es ou la date de fin atteinte.
                </div>

                <h5>Gestion du Cycle de Vie:</h5>
                <ul>
                    <li><strong>Modification:</strong> ModifierOrdreVirementPermanentTrt.java</li>
                    <li><strong>Modification √©ch√©ance:</strong> ModificationEcheanceDetailVirementPermanentTrt.java</li>
                    <li><strong>Suppression √©ch√©ance:</strong> SupprimerEcheanceDetailVirementPermanentTrt.java</li>
                    <li><strong>R√©siliation:</strong> ResiliationVirementTrt.java</li>
                    <li><strong>R√©activation:</strong> ReactiverGlobalVirementTrt.java</li>
                </ul>
            </div>

            <div class="type-virement">
                <h4>2.3 Virement de Masse <span class="badge badge-primary">COD_PRD_VIR_MASSE = 1065</span></h4>
                <p><strong>Description:</strong> Virement pour plusieurs b√©n√©ficiaires, g√©n√©ralement utilis√© pour les salaires ou paiements en masse.</p>

                <div class="caracteristiques">
                    <div class="caracteristique-item">
                        <strong>Classe Contr√¥leur:</strong>
                        PecVirementMasseCtr.java
                    </div>
                    <div class="caracteristique-item">
                        <strong>Traitement Ex√©cution:</strong>
                        TraiterExecutionVirPonctuelMasseTrt.java
                    </div>
                    <div class="caracteristique-item">
                        <strong>CRO Principal:</strong>
                        CreationCROExecutionVirementMasseTrt (717)
                    </div>
                    <div class="caracteristique-item">
                        <strong>Distinction:</strong>
                        Masse Salaire vs Masse Petit
                    </div>
                </div>

                <h5>Sous-Types:</h5>
                <ul>
                    <li><strong>Virement Masse Salaire:</strong> Si nbreVirementMasseBNABNA >= param√®tre minimum (ex: 10 virements)
                        <ul>
                            <li>Traitement: ExecutionDoVirMasseSalaireTrt.java</li>
                            <li>Conditions bancaires sp√©cifiques pour salaires</li>
                        </ul>
                    </li>
                    <li><strong>Virement Masse Petit:</strong> Nombre de virements < seuil
                        <ul>
                            <li>Traitement: ExecutionDoVirMasseTrt.java</li>
                            <li>Trait√© comme plusieurs virements ponctuels</li>
                        </ul>
                    </li>
                </ul>

                <h5>Gestion Fichier:</h5>
                <ul>
                    <li><strong>nomFichGvir:</strong> Nom du fichier upload√© contenant les d√©tails</li>
                    <li>Format attendu: CSV ou format propri√©taire</li>
                    <li>Parsing et validation de chaque ligne</li>
                    <li>Cr√©ation automatique des DetailVirement</li>
                </ul>

                <div class="alert alert-success">
                    <strong>‚úì Avantage:</strong> Permet de traiter simultan√©ment des centaines de virements avec une seule op√©ration de d√©bit global.
                </div>
            </div>

            <div class="type-virement">
                <h4>2.4 Virement en Devise <span class="badge badge-primary">COD_PRD_VIR_DEVISE</span></h4>
                <p><strong>Description:</strong> Virement en devises √©trang√®res avec conversion en dinars.</p>

                <div class="caracteristiques">
                    <div class="caracteristique-item">
                        <strong>Classe Contr√¥leur:</strong>
                        PecVirementDeviseCtr.java
                    </div>
                    <div class="caracteristique-item">
                        <strong>Traitement Ex√©cution:</strong>
                        ExecutionDoVirDeviseTrt.java
                    </div>
                    <div class="caracteristique-item">
                        <strong>CRO √âmis:</strong>
                        CreationCROVirementEmisDeviseTrt (2086)
                    </div>
                    <div class="caracteristique-item">
                        <strong>CRO Re√ßu:</strong>
                        CreationCROVirementRecuDeviseTrt (2087)
                    </div>
                </div>

                <h5>Attributs Sp√©cifiques Devise:</h5>
                <ul>
                    <li><strong>codDevDev:</strong> Code devise (EUR, USD, GBP, etc.)</li>
                    <li><strong>mntDevGvir:</strong> Montant en devise</li>
                    <li><strong>courFixGvir:</strong> Cours de change fix√©</li>
                    <li><strong>refDosTtnDetv:</strong> R√©f√©rence dossier de transfert de titres</li>
                </ul>

                <h5>Calcul du Montant:</h5>
                <div class="code-block">
<span class="comment">// Conversion devise vers dinars</span>
montantDinars = mntDevGvir * courFixGvir;

<span class="comment">// V√©rification disponibilit√© devises</span>
montantTotalDevises = montSoldeDevises - montBloqueDevises;

<span class="keyword">if</span> (montantTotalDevises &lt; mntDevGvir) {
    <span class="comment">// Provision insuffisante en devises</span>
    rejetVirement(<span class="string">"Provision insuffisante en devises"</span>);
}
                </div>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Contr√¥le R√©glementaire:</strong> Les virements en devises sont soumis √† des contr√¥les r√©glementaires sp√©cifiques et n√©cessitent souvent des autorisations de la BCT (Banque Centrale de Tunisie).
                </div>
            </div>

            <div class="type-virement">
                <h4>2.5 Virement SGMT <span class="badge badge-danger">Montant >= MONTANT_VIREMENT_SGMT</span></h4>
                <p><strong>Description:</strong> Virement de gros montant trait√© via le Syst√®me de Gros Montant Tunisien de la BCT.</p>

                <div class="caracteristiques">
                    <div class="caracteristique-item">
                        <strong>Seuil:</strong>
                        Constants.MONTANT_VIREMENT_SGMT
                    </div>
                    <div class="caracteristique-item">
                        <strong>Table Sp√©cifique:</strong>
                        VIR_SGMT
                    </div>
                    <div class="caracteristique-item">
                        <strong>CRO R√©ception:</strong>
                        CreationCROReceptionVirementSGMTTrt (1203)
                    </div>
                    <div class="caracteristique-item">
                        <strong>Code Unique:</strong>
                        ddMMyy + numVirSgmt
                    </div>
                </div>

                <h5>Contraintes SGMT:</h5>
                <ul>
                    <li><strong>Plages Horaires:</strong> V√©rification table JOURNEE_SGMT
                        <ul>
                            <li>numHdjJrn: Heure d√©but journ√©e SGMT</li>
                            <li>numHfjJrn: Heure fin journ√©e SGMT</li>
                        </ul>
                    </li>
                    <li><strong>Validation Journ√©e:</strong> La journ√©e SGMT doit √™tre ouverte</li>
                    <li><strong>Codes Op√©ration SGMT:</strong>
                        <ul>
                            <li>VBSC: Virement BNA vers Si√®ge Central</li>
                            <li>VBO: Virement BNA Ordinaire</li>
                            <li>VBB: Virement BNA vers Autre Banque</li>
                            <li>VBTC: Virement BNA Tr√©sor Central</li>
                            <li>VBCP: Virement BNA Compte Propre</li>
                            <li>VBP: Virement BNA Prioritaire</li>
                        </ul>
                    </li>
                </ul>

                <h5>Structure Table VIR_SGMT:</h5>
                <div class="code-block">
<span class="comment">// Insertion dans VIR_SGMT</span>
VirSgmt virSgmt = <span class="keyword">new</span> VirSgmt();
virSgmt.setCodCodVir(genererCodeVirement()); <span class="comment">// ddMMyy + seq</span>
virSgmt.setNumRibdVir(ribDonneurOrdre);
virSgmt.setNumRibbVir(ribBeneficiaire);
virSgmt.setMntVirVir(montantVirement);
virSgmt.setCodOperOpgm(<span class="string">"VBO"</span>); <span class="comment">// Code op√©ration SGMT</span>
virSgmt.setLibMotifVir(motif);
crudService.create(virSgmt);
                </div>

                <div class="alert alert-danger">
                    <strong>‚ö†Ô∏è Rejet Hors Plage:</strong> Si le virement SGMT est demand√© en dehors des heures d'ouverture du syst√®me SGMT, il sera automatiquement rejet√© avec le motif: "La journ√©e SGMT n'est pas encore ouverte ou elle est cl√¥tur√©e".
                </div>
            </div>

            <div class="type-virement">
                <h4>2.6 Virement Compte √† Compte <span class="badge badge-success">M√™me Client</span></h4>
                <p><strong>Description:</strong> Virement entre deux comptes du m√™me client ou de la m√™me agence.</p>

                <div class="caracteristiques">
                    <div class="caracteristique-item">
                        <strong>Classe Contr√¥leur:</strong>
                        PecVirementCompteACompteCtr.java
                    </div>
                    <div class="caracteristique-item">
                        <strong>Traitement Validation:</strong>
                        ValiderVirementCompteACompteTrt.java
                    </div>
                    <div class="caracteristique-item">
                        <strong>Paliers CB Sp√©cifiques:</strong>
                        48, 52, 106
                    </div>
                    <div class="caracteristique-item">
                        <strong>Ex√©cution:</strong>
                        Imm√©diate si provision
                    </div>
                </div>

                <h5>Paliers de Conditions Bancaires:</h5>
                <table>
                    <thead>
                        <tr>
                            <th>Palier</th>
                            <th>Description</th>
                            <th>Commission</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge badge-primary">48</span></td>
                            <td>M√™me agence, m√™me personne</td>
                            <td>G√©n√©ralement r√©duite</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-primary">52</span></td>
                            <td>M√™me agence, personne diff√©rente</td>
                            <td>Standard</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-primary">106</span></td>
                            <td>Comptes d'√©pargne li√©s</td>
                            <td>Sp√©cifique √©pargne</td>
                        </tr>
                    </tbody>
                </table>

                <h5>Contr√¥le Unicit√©:</h5>
                <div class="code-block">
<span class="comment">// V√©rification doublon dans les derni√®res 24h</span>
<span class="keyword">int</span> nombreVirementsIdentiques = getNbreVirementAvecMemeDonnees(
    compteDoId,
    produitVirement,
    montant,
    dateCreation,
    ribBeneficiaire,
    motif
);

<span class="keyword">if</span> (nombreVirementsIdentiques > <span class="string">0</span>) {
    <span class="keyword">throw new</span> Exception(<span class="string">"Virement identique d√©j√† effectu√© aujourd'hui"</span>);
}
                </div>
            </div>

            <div class="type-virement">
                <h4>2.7 Virement Centrale (CAPI) <span class="badge badge-warning">Direction Centrale</span></h4>
                <p><strong>Description:</strong> Virement g√©r√© au niveau de la direction centrale de la banque.</p>

                <div class="caracteristiques">
                    <div class="caracteristique-item">
                        <strong>Classe Contr√¥leur:</strong>
                        PecVirementCentralCtr.java
                    </div>
                    <div class="caracteristique-item">
                        <strong>Code Produit:</strong>
                        Constants.COD_PROD_VIR_CAPI
                    </div>
                    <div class="caracteristique-item">
                        <strong>Traitement Ex√©cution:</strong>
                        TraiterExecutionVirCapiTrt.java
                    </div>
                    <div class="caracteristique-item">
                        <strong>CRO Principal:</strong>
                        CreationCROExecutionVirementCapiTrt
                    </div>
                </div>

                <h5>Caract√©ristiques Sp√©cifiques:</h5>
                <ul>
                    <li><strong>refDossierCapi:</strong> R√©f√©rence du dossier CAPI</li>
                    <li>Traitement centralis√© au niveau du si√®ge</li>
                    <li>Workflow d'approbation sp√©cifique</li>
                    <li>Reporting distinct des virements agence</li>
                </ul>

                <h5>CRO Sp√©cifiques CAPI:</h5>
                <ul>
                    <li><strong>CreationCROExecutionVirementCapiTrt:</strong> Ex√©cution virement CAPI √©mis</li>
                    <li><strong>CreationCROExecutionVirementCapiRecuTrt:</strong> R√©ception virement CAPI</li>
                    <li><strong>VirementAgenceCapiDuJourTrt:</strong> R√©capitulatif journalier des virements CAPI</li>
                </ul>
            </div>
        </section>

        <section id="section3">
            <h2>3. Architecture des CRO (Comptes Rendus d'Op√©ration)</h2>

            <div class="alert alert-info">
                <strong>üìò D√©finition CRO:</strong> Un Compte Rendu d'Op√©ration (CRO) est un enregistrement comptable g√©n√©r√© automatiquement lors d'une op√©ration bancaire. Il contient l'ensemble des informations n√©cessaires √† la tra√ßabilit√© et √† la comptabilisation de l'op√©ration.
            </div>

            <h3>3.1 Liste Compl√®te des CRO de Virement</h3>

            <table>
                <thead>
                    <tr>
                        <th>Code CRO</th>
                        <th>Classe Java</th>
                        <th>Op√©ration</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge badge-primary">715</span></td>
                        <td>CreationCROExecutionVirementPonctuelTrt</td>
                        <td>Ex√©cution virement ponctuel DO</td>
                        <td>D√©bit DO</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-primary">716</span></td>
                        <td>CreationCROExecutionVirementPermanentTrt</td>
                        <td>Ex√©cution virement permanent DO</td>
                        <td>D√©bit DO</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-primary">717</span></td>
                        <td>CreationCROExecutionVirementMasseTrt</td>
                        <td>Ex√©cution virement masse DO</td>
                        <td>D√©bit DO</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">721</span></td>
                        <td>CreationCROEnvoiVirementTrt</td>
                        <td>Envoi virement vers autre structure</td>
                        <td>Envoi</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">821</span></td>
                        <td>CreationCROReceptionVirementParAgenceTrt</td>
                        <td>R√©ception virement par agence</td>
                        <td>R√©ception</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-success">822</span></td>
                        <td>CreationCROPositionVirementTrt</td>
                        <td>Position virement b√©n√©ficiaire</td>
                        <td>Cr√©dit B√©n√©f</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-danger">823</span></td>
                        <td>CreationCRORejetVirementTrt</td>
                        <td>Rejet de virement</td>
                        <td>Rejet</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-danger">824</span></td>
                        <td>CreationCROEnvoiRejetsVirementTrt</td>
                        <td>Envoi rejets virement</td>
                        <td>Envoi Rejet</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-danger">947</span></td>
                        <td>CreationCROReceptionRejetsVirementParAgenceTrt</td>
                        <td>R√©ception rejets par agence</td>
                        <td>R√©ception Rejet</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-danger">948</span></td>
                        <td>CreationCROReaffectationRejetsVirementTrt</td>
                        <td>R√©affectation rejets virement</td>
                        <td>R√©affectation</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-warning">1203</span></td>
                        <td>CreationCROReceptionVirementSGMTTrt</td>
                        <td>R√©ception virement SGMT</td>
                        <td>SGMT</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-warning">1064</span></td>
                        <td>CreationCROPositionVirementCompteDevisesTrt</td>
                        <td>Position virement compte devises</td>
                        <td>Devises</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-warning">2086</span></td>
                        <td>CreationCROVirementEmisDeviseTrt</td>
                        <td>Virement √©mis en devise</td>
                        <td>Devise √âmis</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-warning">2087</span></td>
                        <td>CreationCROVirementRecuDeviseTrt</td>
                        <td>Virement re√ßu en devise</td>
                        <td>Devise Re√ßu</td>
                    </tr>
                </tbody>
            </table>

            <h3>3.2 Structure D√©taill√©e d'un CRO (Exemple CRO 715)</h3>

            <div class="file-path">smile/model/virement/traitement/CreationCROExecutionVirementPonctuelTrt.java</div>

            <h4>3.2.1 Composantes d'un CRO</h4>

            <div class="code-block">
<span class="keyword">public class</span> CreationCROExecutionVirementPonctuelTrt <span class="keyword">extends</span> Traitement {

    <span class="keyword">public</span> IValueObject perform(IValueObject vo) {

        <span class="comment">// 1. Cr√©ation OperationMoyPay (op√©ration comptable)</span>
        OperationMoyPay operationMoyPayCompteDO = <span class="keyword">new</span> OperationMoyPay();
        operationMoyPayCompteDO.setCodOperOper(Constants.COD_OPER_EXECUTION_VIREMENT_PONCTUEL);
        operationMoyPayCompteDO.setTache(tache); <span class="comment">// Op√©ration + T√¢che</span>
        operationMoyPayCompteDO.setContratCpt(contratCptDO);
        operationMoyPayCompteDO.setCodSensOmp(Constants.COD_SENS_DB); <span class="comment">// DEBIT</span>

        <span class="comment">// 2. Calcul des montants</span>
        operationMoyPayCompteDO.setMontDinOmp(montantGlobalVirement);
        operationMoyPayCompteDO.setMontTvaOmp(montant_tva);
        operationMoyPayCompteDO.setDatOperOmp(dateComptable);
        operationMoyPayCompteDO.setDatValOmp(dateValeur);
        operationMoyPayCompteDO.setDateValeurCommission(dateValeurCommission);

        <span class="comment">// 3. Insertion OperationMoyPay sans g√©n√©ration CRO automatique</span>
        InsertionOperationMoyPaySansCROTrt insertTrt = <span class="keyword">new</span> InsertionOperationMoyPaySansCROTrt();
        operationMoyPayCompteDO = (OperationMoyPay) insertTrt.exec(operationMoyPayCompteDO);

        <span class="comment">// 4. Mise √† jour du solde compte DO</span>
        ContratCptSold contratCptSold = <span class="keyword">new</span> ContratCptSold();
        contratCptSold.setContratCpt(contratCptDO);
        contratCptSold.setSens(Constants.COD_SENS_DB); <span class="comment">// D√©bit</span>
        contratCptSold.setSolde(montantAjouterAuSolde);
        contratCptDO = (ContratCpt) communService.UpdateSoldOperationMoyPay(contratCptSold);

        <span class="comment">// 5. Cr√©ation TraceVirement (tra√ßabilit√© flux)</span>
        TraceVirement traceVirement = <span class="keyword">new</span> TraceVirement();
        traceVirement.setGlobalVirement(globalVirement);
        traceVirement.setOperation(operation);
        traceVirement.setSens(Constants.COD_SENS_EMIS); <span class="comment">// E=√âmis, R=Re√ßu</span>
        traceVirement.setMontVirTrace(montantGlobalVirement);
        traceVirement.setCodStrcStrc(structureEmettrice);
        crudService.create(traceVirement);

        <span class="comment">// 6. Cr√©ation DetailsOperationVirement (d√©tails financiers)</span>
        DetailsOperationVirement detailsOperationVirement = <span class="keyword">new</span> DetailsOperationVirement();
        detailsOperationVirement.setGlobalVirement(globalVirement);
        detailsOperationVirement.setMontOpeDovi(montantGlobalVirement);
        detailsOperationVirement.setMontComDovi(montant_commision);
        detailsOperationVirement.setMontTvaDovi(montant_tva);
        detailsOperationVirement.setDatOperDovi(dateComptable);
        detailsOperationVirement.setDatValDovi(dateValeur);
        detailsOperationVirement.setDatValcDovi(dateValeurCommission);
        crudService.create(detailsOperationVirement);

        <span class="comment">// 7. G√©n√©ration du texte CRO</span>
        genCroText(vo);

        <span class="keyword">return</span> vo;
    }

    <span class="comment">// M√©thode de g√©n√©ration du texte CRO</span>
    <span class="keyword">public void</span> genCroText(ValueObject vo) {
        StringBuffer cro = <span class="keyword">new</span> StringBuffer(<span class="string">""</span>);
        cro.append(<span class="string">"NumCptVir="</span>).append(globalVirement.getCompteDO() + <span class="string">";"</span>);
        cro.append(<span class="string">"MNT_GLO_REM="</span>).append(montantGlobalVirement + <span class="string">";"</span>);
        cro.append(<span class="string">"NBR_VIR_PALIER="</span>).append(nbreGlobal + <span class="string">";"</span>);
        cro.append(<span class="string">"267="</span>).append(montant_commision + <span class="string">";"</span>); <span class="comment">// Commission</span>
        cro.append(<span class="string">"MNT_TVA_VEM="</span>).append(montant_tva + <span class="string">";"</span>);
        cro.append(<span class="string">"COD_TVA_CLT="</span>).append(etatClientTaxable ? <span class="string">"0"</span> : <span class="string">"1"</span> + <span class="string">";"</span>);
        cro.append(<span class="string">"COD_REM_VIR="</span>).append(globalVirement.getNumSeqGvir() + <span class="string">";"</span>);
        cro.append(<span class="string">"NUM_SEQ_COND="</span>).append(numCondition + <span class="string">";"</span>);
        cro.append(<span class="string">"COD_TYP_COND="</span>).append(typeCondition + <span class="string">";"</span>);

        <span class="keyword">this</span>.setCroText(cro.toString());
    }
}
            </div>

            <h4>3.2.2 Flux de Cr√©ation CRO</h4>

            <div class="flowchart">
                <div class="flowchart-step">
                    <h5>√âtape 1: Pr√©paration Donn√©es</h5>
                    <p>R√©cup√©ration du GlobalVirement, ContratCpt, Conditions Bancaires, Param√®tres agence</p>
                </div>

                <div class="flowchart-step">
                    <h5>√âtape 2: Calcul Montants</h5>
                    <p>Calcul commission et TVA via TraitementConditionBanque.getCB()</p>
                    <p><strong>Montant Total √† D√©biter = Montant Virement + Commission + TVA</strong></p>
                </div>

                <div class="flowchart-step">
                    <h5>√âtape 3: Cr√©ation OperationMoyPay</h5>
                    <p>Enregistrement dans OPERATION_MOY_PAY avec sens DEBIT pour le compte donneur d'ordre</p>
                </div>

                <div class="flowchart-step">
                    <h5>√âtape 4: Mise √† Jour Solde</h5>
                    <p>D√©bit du compte donneur d'ordre: Solde -= (Montant + Commission + TVA)</p>
                </div>

                <div class="flowchart-step">
                    <h5>√âtape 5: Tra√ßabilit√©</h5>
                    <p>Cr√©ation TraceVirement (flux) et DetailsOperationVirement (d√©tails financiers)</p>
                </div>

                <div class="flowchart-step">
                    <h5>√âtape 6: G√©n√©ration Texte CRO</h5>
                    <p>Formatage du texte CRO avec tous les param√®tres de l'op√©ration</p>
                </div>
            </div>

            <h3>3.3 CRO de Positionnement B√©n√©ficiaire (CRO 822)</h3>

            <div class="file-path">smile/model/virement/traitement/CreationCROPositionVirementTrt.java</div>

            <p>Ce CRO est g√©n√©r√© lorsque le virement est positionn√© (cr√©dit√©) sur le compte du b√©n√©ficiaire.</p>

            <div class="code-block">
<span class="keyword">public class</span> CreationCROPositionVirementTrt <span class="keyword">extends</span> Traitement {

    <span class="keyword">public</span> IValueObject perform(IValueObject vo) {

        <span class="comment">// 1. V√©rification validit√© compte b√©n√©ficiaire</span>
        VerifierValiditerCompteDoTrt verifierTrt = <span class="keyword">new</span> VerifierValiditerCompteDoTrt();
        <span class="keyword">boolean</span> compteValide = verifierTrt.verifierCompte(ribBeneficiaire);

        <span class="keyword">if</span> (!compteValide) {
            <span class="comment">// Rejet du virement - CRO 823 sera g√©n√©r√©</span>
            <span class="keyword">return</span> rejeterVirement(detailVirement);
        }

        <span class="comment">// 2. Cr√©ation OperationMoyPay b√©n√©ficiaire (CREDIT)</span>
        OperationMoyPay operationBenef = <span class="keyword">new</span> OperationMoyPay();
        operationBenef.setCodOperOper(Constants.COD_OPER_POSITION_VIREMENT);
        operationBenef.setContratCpt(contratCptBeneficiaire);
        operationBenef.setCodSensOmp(Constants.COD_SENS_CR); <span class="comment">// CREDIT</span>
        operationBenef.setMontDinOmp(montantVirement);
        operationBenef.setDatOperOmp(dateComptable);
        operationBenef.setDatValOmp(dateValeur);

        <span class="comment">// 3. Insertion sans g√©n√©ration CRO auto</span>
        InsertionOperationMoyPaySansCROTrt insertTrt = <span class="keyword">new</span> InsertionOperationMoyPaySansCROTrt();
        operationBenef = (OperationMoyPay) insertTrt.exec(operationBenef);

        <span class="comment">// 4. Mise √† jour solde b√©n√©ficiaire (CREDIT)</span>
        ContratCptSold contratCptSold = <span class="keyword">new</span> ContratCptSold();
        contratCptSold.setContratCpt(contratCptBeneficiaire);
        contratCptSold.setSens(Constants.COD_SENS_CR); <span class="comment">// Cr√©dit</span>
        contratCptSold.setSolde(montantVirement);
        contratCptBeneficiaire = (ContratCpt) communService.UpdateSoldOperationMoyPay(contratCptSold);

        <span class="comment">// 5. Mise √† jour DetailVirement</span>
        detailVirement.setEtaDetvDetv(Constants.COD_ETAT_VIREMENT_EXECUTER);
        detailVirement.setDatExecDetv(dateComptable);
        detailVirement.setTimeExecDetv(heureExecution);
        crudService.update(detailVirement);

        <span class="comment">// 6. Cr√©ation TraceVirement sens RECU</span>
        TraceVirement traceVirement = <span class="keyword">new</span> TraceVirement();
        traceVirement.setSens(Constants.COD_SENS_RECU); <span class="comment">// R=Re√ßu</span>
        traceVirement.setMontVirTrace(montantVirement);
        traceVirement.setCodStrcRecp(structureBeneficiaire);
        crudService.create(traceVirement);

        <span class="comment">// 7. G√©n√©ration texte CRO</span>
        genCroText(vo);

        <span class="keyword">return</span> vo;
    }

    <span class="keyword">public void</span> genCroText(ValueObject vo) {
        StringBuffer cro = <span class="keyword">new</span> StringBuffer(<span class="string">""</span>);
        cro.append(<span class="string">"NumCptBenef="</span>).append(ribBeneficiaire + <span class="string">";"</span>);
        cro.append(<span class="string">"NomBenef="</span>).append(nomBeneficiaire + <span class="string">";"</span>);
        cro.append(<span class="string">"MNT_VIR="</span>).append(montantVirement + <span class="string">";"</span>);
        cro.append(<span class="string">"MOTIF="</span>).append(motifVirement + <span class="string">";"</span>);
        cro.append(<span class="string">"COD_REM_VIR="</span>).append(numSeqGvir + <span class="string">";"</span>);
        cro.append(<span class="string">"RIB_DO="</span>).append(ribDonneurOrdre + <span class="string">";"</span>);
        cro.append(<span class="string">"NOM_DO="</span>).append(nomDonneurOrdre + <span class="string">";"</span>);

        <span class="keyword">this</span>.setCroText(cro.toString());
    }
}
            </div>

            <h3>3.4 CRO de Rejet (CRO 823)</h3>

            <div class="file-path">smile/model/virement/traitement/CreationCRORejetVirementTrt.java</div>

            <p>Ce CRO est g√©n√©r√© lorsqu'un virement est rejet√©, notamment si le RIB b√©n√©ficiaire est invalide ou le compte est cl√¥tur√©.</p>

            <div class="alert alert-danger">
                <strong>‚ö†Ô∏è Impact Financier:</strong> Le CRO 823 g√©n√®re une op√©ration de CREDIT pour rembourser le compte donneur d'ordre du montant pr√©c√©demment d√©bit√© (annulation du d√©bit initial).
            </div>

            <div class="code-block">
<span class="keyword">public class</span> CreationCRORejetVirementTrt <span class="keyword">extends</span> Traitement {

    <span class="keyword">public</span> IValueObject perform(IValueObject vo) {

        <span class="comment">// 1. Cr√©ation OperationMoyPay pour remboursement DO</span>
        OperationMoyPay operationRejet = <span class="keyword">new</span> OperationMoyPay();
        operationRejet.setCodOperOper(Constants.COD_OPER_REJET_VIREMENT);
        operationRejet.setContratCpt(contratCptDO);
        operationRejet.setCodSensOmp(Constants.COD_SENS_CR); <span class="comment">// CREDIT pour remboursement</span>
        operationRejet.setMontDinOmp(montantVirement);
        operationRejet.setDatOperOmp(dateComptable);

        <span class="comment">// 2. Remboursement commission et TVA</span>
        operationRejet.setMontTvaOmp(montant_tva);
        DetailsOperationVirement detailsOp = <span class="keyword">new</span> DetailsOperationVirement();
        detailsOp.setMontComDovi(montant_commission);

        <span class="comment">// 3. Insertion OperationMoyPay</span>
        InsertionOperationMoyPaySansCROTrt insertTrt = <span class="keyword">new</span> InsertionOperationMoyPaySansCROTrt();
        operationRejet = (OperationMoyPay) insertTrt.exec(operationRejet);

        <span class="comment">// 4. Mise √† jour solde DO (CREDIT = remboursement)</span>
        ContratCptSold contratCptSold = <span class="keyword">new</span> ContratCptSold();
        contratCptSold.setSens(Constants.COD_SENS_CR);
        contratCptSold.setSolde(montantVirement + montant_commission + montant_tva);
        contratCptDO = (ContratCpt) communService.UpdateSoldOperationMoyPay(contratCptSold);

        <span class="comment">// 5. Mise √† jour DetailVirement</span>
        detailVirement.setEtaDetvDetv(Constants.COD_ETAT_VIREMENT_REJETER);
        detailVirement.setMotifRejetDetv(motifRejet);
        detailVirement.setDatExecDetv(dateComptable);
        crudService.update(detailVirement);

        <span class="comment">// 6. Mise √† jour compteurs GlobalVirement</span>
        globalVirement.setNbrRejetGvir(globalVirement.getNbrRejetGvir() + <span class="string">1</span>);
        globalVirement.setMntRejetGvir(globalVirement.getMntRejetGvir() + montantVirement);
        crudService.update(globalVirement);

        <span class="comment">// 7. Cr√©ation TraceOperVirement pour historique</span>
        TraceOperVirement traceOper = <span class="keyword">new</span> TraceOperVirement();
        traceOper.setNumSeqGvir(globalVirement.getNumSeqGvir());
        traceOper.setNumSeqDetv(detailVirement.getNumSeqDetv());
        traceOper.setCodOperOper(Constants.COD_OPER_REJET_VIREMENT);
        traceOper.setDatOperTvir(dateComptable);
        crudService.create(traceOper);

        <span class="comment">// 8. G√©n√©ration texte CRO avec motif rejet</span>
        genCroText(vo);

        <span class="keyword">return</span> vo;
    }

    <span class="keyword">public void</span> genCroText(ValueObject vo) {
        StringBuffer cro = <span class="keyword">new</span> StringBuffer(<span class="string">""</span>);
        cro.append(<span class="string">"COD_REM_VIR="</span>).append(numSeqGvir + <span class="string">";"</span>);
        cro.append(<span class="string">"NUM_SEQ_DETV="</span>).append(numSeqDetv + <span class="string">";"</span>);
        cro.append(<span class="string">"MNT_REJETE="</span>).append(montantVirement + <span class="string">";"</span>);
        cro.append(<span class="string">"MOTIF_REJET="</span>).append(motifRejet + <span class="string">";"</span>);
        cro.append(<span class="string">"RIB_BENEF_INVALIDE="</span>).append(ribBeneficiaire + <span class="string">";"</span>);
        cro.append(<span class="string">"MNT_REMB_COMMISSION="</span>).append(montant_commission + <span class="string">";"</span>);
        cro.append(<span class="string">"MNT_REMB_TVA="</span>).append(montant_tva + <span class="string">";"</span>);

        <span class="keyword">this</span>.setCroText(cro.toString());
    }
}
            </div>

            <h3>3.5 S√©quence Compl√®te des CRO pour un Virement Inter-Agences</h3>

            <div class="flowchart">
                <div class="flowchart-step">
                    <h5>CRO 715: Ex√©cution DO (Agence √âmettrice)</h5>
                    <p><strong>Op√©ration:</strong> D√©bit compte donneur d'ordre</p>
                    <p><strong>Tables impact√©es:</strong> OPERATION_MOY_PAY, CONTRAT_CPT (solde), DETAILS_OPERATION_VIREMENT, TRACE_VIREMENT</p>
                </div>

                <div class="flowchart-step">
                    <h5>CRO 721: Envoi Virement (Agence √âmettrice)</h5>
                    <p><strong>Op√©ration:</strong> Notification envoi vers agence b√©n√©ficiaire</p>
                    <p><strong>Tables impact√©es:</strong> FLUX_COMPT_VIREMENT, TRACE_VIREMENT</p>
                </div>

                <div class="flowchart-step">
                    <h5>CRO 821: R√©ception Virement (Agence B√©n√©ficiaire)</h5>
                    <p><strong>Op√©ration:</strong> R√©ception virement dans agence b√©n√©ficiaire</p>
                    <p><strong>Tables impact√©es:</strong> TRACE_VIREMENT</p>
                </div>

                <div class="flowchart-step">
                    <h5>CRO 822: Position B√©n√©ficiaire (Agence B√©n√©ficiaire)</h5>
                    <p><strong>Op√©ration:</strong> Cr√©dit compte b√©n√©ficiaire</p>
                    <p><strong>Tables impact√©es:</strong> OPERATION_MOY_PAY, CONTRAT_CPT (solde), DETAIL_VIREMENT (√©tat = EXECUTER)</p>
                </div>
            </div>

            <div class="alert alert-success">
                <strong>‚úì R√©sultat:</strong> Le virement est compl√®tement ex√©cut√©. Le compte DO est d√©bit√© dans son agence, et le compte b√©n√©ficiaire est cr√©dit√© dans son agence. Toutes les op√©rations sont trac√©es pour l'audit et la comptabilit√©.
            </div>
        </section>

        <section id="section4">
            <h2>4. Traitements de Virement</h2>

            <p>Cette section d√©taille les principaux traitements Java qui orchestrent les op√©rations de virement.</p>

            <h3>4.1 Traitement de Sauvegarde (SaveGlobalVirementTrt)</h3>

            <div class="file-path">smile/model/virement/traitement/SaveGlobalVirementTrt.java</div>

            <h4>Responsabilit√©s:</h4>
            <ul>
                <li>G√©n√©ration du num√©ro de remise unique</li>
                <li>Cr√©ation de l'entit√© GlobalVirement</li>
                <li>Cr√©ation de la trace d'op√©ration initiale</li>
                <li>Gestion des mandataires/cotitulaires</li>
            </ul>

            <h4>Algorithme de G√©n√©ration du Num√©ro de Remise:</h4>
            <div class="code-block">
<span class="comment">// Format: [CodStrc(3)][Ann√©e(4)][S√©quence(5)]</span>
<span class="comment">// Exemple: 0012026000015 = Agence 001, Ann√©e 2026, S√©quence 00015</span>

<span class="keyword">public</span> String genererNumeroRemise(Long codStrcStrc, Date dateComptable) {

    <span class="comment">// 1. R√©cup√©ration de la s√©quence agence</span>
    SeqAgence seqAgence = getSeqAgence(codStrcStrc, <span class="string">"SEQ_GLOB_VIR"</span>);
    Long numValSeq = seqAgence.getNumValSeqa();

    <span class="comment">// 2. Incr√©mentation de la s√©quence</span>
    seqAgence.setNumValSeqa(numValSeq + <span class="string">1</span>);
    crudService.update(seqAgence);

    <span class="comment">// 3. Formatage du num√©ro de remise</span>
    SimpleDateFormat dateFormatANNEE = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy"</span>);
    String numeroRemise = StrHandler.lpad(codStrcStrc + <span class="string">""</span>, <span class="string">'0'</span>, <span class="string">3</span>)
                        + dateFormatANNEE.format(dateComptable)
                        + StrHandler.lpad(numValSeq + <span class="string">""</span>, <span class="string">'0'</span>, <span class="string">5</span>);

    <span class="keyword">return</span> numeroRemise;
}
            </div>

            <h4>Flux du Traitement:</h4>
            <div class="flowchart">
                <div class="flowchart-step">
                    <h5>1. Validation des Donn√©es d'Entr√©e</h5>
                    <p>V√©rification pr√©sence de toutes les donn√©es obligatoires (compte DO, montant, b√©n√©ficiaires)</p>
                </div>

                <div class="flowchart-step">
                    <h5>2. G√©n√©ration Num√©ro de Remise</h5>
                    <p>Appel √† la s√©quence SEQ_GLOB_VIR pour obtenir un num√©ro unique</p>
                </div>

                <div class="flowchart-step">
                    <h5>3. Cr√©ation GlobalVirement</h5>
                    <p>Insertion dans table GLOBAL_VIREMENT avec √©tat ATTENTE (0)</p>
                </div>

                <div class="flowchart-step">
                    <h5>4. Cr√©ation DetailVirement(s)</h5>
                    <p>Pour chaque b√©n√©ficiaire, cr√©ation d'un DetailVirement avec √©tat ATTENTE (0)</p>
                </div>

                <div class="flowchart-step">
                    <h5>5. Gestion Pouvoir</h5>
                    <p>Si mandataire: cr√©ation MANDANT_PERS_VIREMENT<br>
                    Si cotitulaire: cr√©ation PERS_COTIT_VIREMENT</p>
                </div>

                <div class="flowchart-step">
                    <h5>6. Trace Op√©ration Initiale</h5>
                    <p>Cr√©ation TRACE_OPER_VIREMENT avec COD_OPER_DEMANDE_VIREMENT</p>
                </div>
            </div>

            <h3>4.2 Traitement d'Ex√©cution Ponctuel (ExecutionDoVirPonctuelTrt)</h3>

            <div class="file-path">smile/model/virement/traitement/ExecutionDoVirPonctuelTrt.java</div>

            <p>C'est le traitement le plus complexe et central du syst√®me de virement. Il g√®re l'ex√©cution effective du virement c√¥t√© donneur d'ordre.</p>

            <h4>4.2.1 Classification des Virements</h4>

            <table>
                <thead>
                    <tr>
                        <th>Type Destination</th>
                        <th>Crit√®res</th>
                        <th>CRO G√©n√©r√©s</th>
                        <th>Actions Sp√©cifiques</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge badge-success">M√™me Agence</span></td>
                        <td>Code banque = 03<br>M√™me structure</td>
                        <td>715 (DO) + 822 (B√©n√©f)</td>
                        <td>Cr√©dit imm√©diat b√©n√©ficiaire</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-primary">Autre Agence BNA</span></td>
                        <td>Code banque = 03<br>Structure diff√©rente</td>
                        <td>715 (DO) + 721 (Envoi) + 821 (R√©ception) + 822 (B√©n√©f)</td>
                        <td>G√©n√©ration FluxComptVirement</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-warning">Autre Banque ADT</span></td>
                        <td>Code banque ‚â† 03<br>Montant < SGMT</td>
                        <td>715 (DO) + 721 (Envoi)</td>
                        <td>G√©n√©ration fichier SIBTEL</td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-danger">Autre Banque SGMT</span></td>
                        <td>Code banque ‚â† 03<br>Montant >= SGMT</td>
                        <td>715 (DO) + 721 (Envoi) + 1203 (SGMT)</td>
                        <td>Insertion VIR_SGMT</td>
                    </tr>
                </tbody>
            </table>

            <h4>4.2.2 Algorithme Principal</h4>

            <div class="code-block">
<span class="keyword">public</span> IValueObject perform(IValueObject vo) {

    <span class="comment">// PHASE 1: R√©cup√©ration des d√©tails √† ex√©cuter</span>
    List&lt;DetailVirement&gt; listeDetails = getDetailsAExecuter(globalVirement);

    <span class="comment">// PHASE 2: Classification par destination</span>
    Map&lt;String, List&lt;DetailVirement&gt;&gt; mapClassification = <span class="keyword">new</span> HashMap&lt;&gt;();
    mapClassification.put(<span class="string">"MEME_AGENCE"</span>, <span class="keyword">new</span> ArrayList&lt;&gt;());
    mapClassification.put(<span class="string">"AUTRE_AGENCE_BNA"</span>, <span class="keyword">new</span> ArrayList&lt;&gt;());
    mapClassification.put(<span class="string">"AUTRE_BANQUE_ADT"</span>, <span class="keyword">new</span> ArrayList&lt;&gt;());
    mapClassification.put(<span class="string">"AUTRE_BANQUE_SGMT"</span>, <span class="keyword">new</span> ArrayList&lt;&gt;());

    <span class="keyword">for</span> (DetailVirement detail : listeDetails) {
        String ribBenef = detail.getRibBenDetv();
        String codeBanque = ribBenef.substring(<span class="string">0</span>, <span class="string">2</span>);
        String codeStructure = ribBenef.substring(<span class="string">5</span>, <span class="string">8</span>);
        Long montantDetail = detail.getMntDetvDetv();

        <span class="keyword">if</span> (codeBanque.equals(<span class="string">"03"</span>)) {
            <span class="comment">// BNA</span>
            <span class="keyword">if</span> (codeStructure.equals(structureDO.getCodStrcStrc().toString())) {
                mapClassification.get(<span class="string">"MEME_AGENCE"</span>).add(detail);
            } <span class="keyword">else</span> {
                mapClassification.get(<span class="string">"AUTRE_AGENCE_BNA"</span>).add(detail);
            }
        } <span class="keyword">else</span> {
            <span class="comment">// Autre banque</span>
            <span class="keyword">if</span> (montantDetail >= Constants.MONTANT_VIREMENT_SGMT) {
                mapClassification.get(<span class="string">"AUTRE_BANQUE_SGMT"</span>).add(detail);
            } <span class="keyword">else</span> {
                mapClassification.get(<span class="string">"AUTRE_BANQUE_ADT"</span>).add(detail);
            }
        }
    }

    <span class="comment">// PHASE 3: Traitement par cat√©gorie</span>

    <span class="comment">// 3.1 Traitement Conditions Bancaires</span>
    Map&lt;String, ConditionBancaire&gt; mapConditions = <span class="keyword">new</span> HashMap&lt;&gt;();
    <span class="keyword">for</span> (String categorie : mapClassification.keySet()) {
        List&lt;DetailVirement&gt; details = mapClassification.get(categorie);
        <span class="keyword">if</span> (!details.isEmpty()) {
            ConditionBancaire cb = getConditionDeBanque(categorie, details);
            mapConditions.put(categorie, cb);
        }
    }

    <span class="comment">// 3.2 Cr√©ation CRO 715 pour d√©bit DO</span>
    CreationCROExecutionVirementPonctuelTrt croExec = <span class="keyword">new</span> CreationCROExecutionVirementPonctuelTrt();
    croExec.perform(vo);

    <span class="comment">// 3.3 Traitement MEME_AGENCE</span>
    List&lt;DetailVirement&gt; detailsMemeAgence = mapClassification.get(<span class="string">"MEME_AGENCE"</span>);
    <span class="keyword">for</span> (DetailVirement detail : detailsMemeAgence) {
        <span class="comment">// V√©rification RIB b√©n√©ficiaire</span>
        <span class="keyword">boolean</span> ribValide = verifierRibBeneficiaire(detail.getRibBenDetv());

        <span class="keyword">if</span> (ribValide) {
            <span class="comment">// CRO 822: Position b√©n√©ficiaire</span>
            CreationCROPositionVirementTrt croPosition = <span class="keyword">new</span> CreationCROPositionVirementTrt();
            croPosition.perform(detail);
        } <span class="keyword">else</span> {
            <span class="comment">// CRO 823: Rejet</span>
            CreationCRORejetVirementTrt croRejet = <span class="keyword">new</span> CreationCRORejetVirementTrt();
            croRejet.perform(detail);

            <span class="comment">// CRO 948: R√©affectation rejet</span>
            CreationCROReaffectationRejetsVirementTrt croReaff = <span class="keyword">new</span> CreationCROReaffectationRejetsVirementTrt();
            croReaff.perform(detail);
        }
    }

    <span class="comment">// 3.4 Traitement AUTRE_AGENCE_BNA</span>
    List&lt;DetailVirement&gt; detailsAutreAgence = mapClassification.get(<span class="string">"AUTRE_AGENCE_BNA"</span>);
    <span class="keyword">if</span> (!detailsAutreAgence.isEmpty()) {
        <span class="comment">// Cr√©ation FluxComptVirement par agence destinataire</span>
        Map&lt;Long, List&lt;DetailVirement&gt;&gt; mapParAgence = grouperParAgence(detailsAutreAgence);

        <span class="keyword">for</span> (Long codStrcDest : mapParAgence.keySet()) {
            List&lt;DetailVirement&gt; detailsAgence = mapParAgence.get(codStrcDest);

            <span class="comment">// Calcul totaux</span>
            Long montantTotal = <span class="string">0L</span>;
            <span class="keyword">for</span> (DetailVirement d : detailsAgence) {
                montantTotal += d.getMntDetvDetv();
            }

            <span class="comment">// Cr√©ation FluxComptVirement</span>
            FluxComptVirement flux = <span class="keyword">new</span> FluxComptVirement();
            flux.setNumSeqGvir(globalVirement.getNumSeqGvir());
            flux.setCodStrcStrc(codStrcDest);
            flux.setMntVirStrc(montantTotal);
            flux.setNbreVirStrc(detailsAgence.size());
            flux.setTypeFluxVir(<span class="string">"0"</span>); <span class="comment">// ADT</span>
            crudService.create(flux);

            <span class="comment">// CRO 721: Envoi virement</span>
            CreationCROEnvoiVirementTrt croEnvoi = <span class="keyword">new</span> CreationCROEnvoiVirementTrt();
            croEnvoi.perform(flux);

            <span class="comment">// CRO 821: R√©ception virement (agence destinataire)</span>
            CreationCROReceptionVirementParAgenceTrt croRecep = <span class="keyword">new</span> CreationCROReceptionVirementParAgenceTrt();
            croRecep.perform(flux);

            <span class="comment">// Traitement b√©n√©ficiaires</span>
            <span class="keyword">for</span> (DetailVirement detail : detailsAgence) {
                <span class="keyword">boolean</span> ribValide = verifierRibBeneficiaire(detail.getRibBenDetv());

                <span class="keyword">if</span> (ribValide) {
                    <span class="comment">// CRO 822: Position b√©n√©ficiaire</span>
                    CreationCROPositionVirementTrt croPosition = <span class="keyword">new</span> CreationCROPositionVirementTrt();
                    croPosition.perform(detail);
                } <span class="keyword">else</span> {
                    <span class="comment">// CRO 823 + 948 + 824 + 947: Gestion rejet inter-agences</span>
                    gererRejetInterAgences(detail);
                }
            }
        }
    }

    <span class="comment">// 3.5 Traitement AUTRE_BANQUE_ADT</span>
    List&lt;DetailVirement&gt; detailsAutreBanqueADT = mapClassification.get(<span class="string">"AUTRE_BANQUE_ADT"</span>);
    <span class="keyword">if</span> (!detailsAutreBanqueADT.isEmpty()) {
        <span class="comment">// CRO 721: Envoi virement</span>
        CreationCROEnvoiVirementTrt croEnvoi = <span class="keyword">new</span> CreationCROEnvoiVirementTrt();
        croEnvoi.perform(detailsAutreBanqueADT);

        <span class="comment">// G√©n√©ration fichier SIBTEL</span>
        CreationFichierVirementTrt fichierTrt = <span class="keyword">new</span> CreationFichierVirementTrt();
        String nomFichier = fichierTrt.genererFichierSIBTEL(detailsAutreBanqueADT);

        <span class="comment">// Mise √† jour r√©f√©rences fichier</span>
        <span class="keyword">for</span> (DetailVirement detail : detailsAutreBanqueADT) {
            detail.setRefFichDetv(nomFichier);
            detail.setCodFlagDetv(<span class="string">"1"</span>); <span class="comment">// Trait√©</span>
            crudService.update(detail);
        }

        <span class="comment">// Envoi FTP vers compensation</span>
        Util.sendFileFTP(nomFichier);
    }

    <span class="comment">// 3.6 Traitement AUTRE_BANQUE_SGMT</span>
    List&lt;DetailVirement&gt; detailsAutreBanqueSGMT = mapClassification.get(<span class="string">"AUTRE_BANQUE_SGMT"</span>);
    <span class="keyword">for</span> (DetailVirement detail : detailsAutreBanqueSGMT) {
        <span class="comment">// V√©rification plage horaire SGMT</span>
        <span class="keyword">boolean</span> sgmtOuvert = verifierPlageHoraireSGMT();

        <span class="keyword">if</span> (!sgmtOuvert) {
            <span class="comment">// Rejet du d√©tail</span>
            RejeterDetailVirementTrt rejetTrt = <span class="keyword">new</span> RejeterDetailVirementTrt();
            rejetTrt.rejeter(detail, <span class="string">"La journ√©e SGMT n'est pas encore ouverte ou elle est cl√¥tur√©e"</span>);
            <span class="keyword">continue</span>;
        }

        <span class="comment">// CRO 721: Envoi virement</span>
        CreationCROEnvoiVirementTrt croEnvoi = <span class="keyword">new</span> CreationCROEnvoiVirementTrt();
        croEnvoi.perform(detail);

        <span class="comment">// CRO 1203: R√©ception SGMT</span>
        CreationCROReceptionVirementSGMTTrt croSGMT = <span class="keyword">new</span> CreationCROReceptionVirementSGMTTrt();
        croSGMT.perform(detail);

        <span class="comment">// Insertion VIR_SGMT</span>
        VirSgmt virSgmt = creerVirSgmt(detail);
        crudService.create(virSgmt);

        <span class="comment">// Mise √† jour r√©f√©rence</span>
        detail.setRefFichDetv(<span class="string">"SGMT"</span>);
        detail.setCodFlagDetv(<span class="string">"1"</span>);
        crudService.update(detail);
    }

    <span class="comment">// PHASE 4: Mise √† jour √©tats</span>
    mettreAJourEtatsGlobalVirement(globalVirement);

    <span class="keyword">return</span> vo;
}
            </div>

            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Performance:</strong> Ce traitement peut g√©n√©rer plusieurs dizaines de CRO pour un seul virement de masse. L'optimisation des requ√™tes base de donn√©es et la gestion transactionnelle sont critiques.
            </div>

            <h3>4.3 Traitement d'Ex√©cution Permanent (TraiterExecutionVirPermanentTrt)</h3>

            <div class="file-path">smile/model/virement/traitement/TraiterExecutionVirPermanentTrt.java</div>

            <p>Ce traitement est ex√©cut√© quotidiennement par batch pour traiter les virements permanents dont l'√©ch√©ance est arriv√©e.</p>

            <h4>Sp√©cificit√©s:</h4>
            <ul>
                <li>Filtre les d√©tails par date d'√©ch√©ance (datEchDetv <= dateComptableAgence)</li>
                <li>G√®re l'alimentation automatique depuis compte vert si manque de provision</li>
                <li>V√©rifie les plages horaires SGMT pour les gros montants</li>
                <li>Traite les comptes d'√©pargne li√©s avec conditions sp√©cifiques</li>
            </ul>

            <h4>Alimentation Automatique depuis Compte Vert:</h4>
            <div class="code-block">
<span class="comment">// Si manque de provision ET compte ch√®que avec compte vert</span>
<span class="keyword">if</span> (montantDisponible &lt; montantNecessaire
    && contratCptDO.getCodPrdPrd().equals(Constants.COD_PRD_COMPTE_CHEQUES)
    && contratCptDO.getBoolCverCcpt() == <span class="string">1</span>) {

    <span class="comment">// R√©cup√©ration compte vert li√© (produit 165)</span>
    ContratCpt compteVert = getCompteVertLie(contratCptDO);

    <span class="keyword">if</span> (compteVert != null) {
        Long montantManquant = montantNecessaire - montantDisponible;

        <span class="comment">// V√©rification solde compte vert</span>
        <span class="keyword">if</span> (compteVert.getMontSoldCcpt() >= montantManquant) {

            <span class="comment">// Alimentation compte d√©p√¥t depuis compte vert</span>
            AlimentationCompteDepotTrt alimentationTrt = <span class="keyword">new</span> AlimentationCompteDepotTrt();
            alimentationTrt.alimenter(compteVert, contratCptDO, montantManquant);

            <span class="comment">// CRO: Alimentation en faveur compte d√©p√¥t</span>
            CreationCROAlimentationFaveurCompteDepotTrt croAlim =
                <span class="keyword">new</span> CreationCROAlimentationFaveurCompteDepotTrt();
            croAlim.perform(compteVert, contratCptDO, montantManquant);

            <span class="comment">// Recalcul montant disponible</span>
            montantDisponible = getMontantDisponible(contratCptDO);
        }
    }
}

<span class="comment">// Si toujours pas de provision suffisante</span>
<span class="keyword">if</span> (montantDisponible &lt; montantNecessaire) {
    <span class="comment">// Changement √©tat d√©tail: DECALAGE_AUTO_J_PLUS_UN ou DECALAGE_AUTO_DEFINITIF</span>
    NonApprovisionDoVirTrt nonApprovTrt = <span class="keyword">new</span> NonApprovisionDoVirTrt();
    nonApprovTrt.decaler(detailVirement);
}
            </div>
        </section>

        <footer>
            <p>&copy; 2026 BNA - Syst√®me SMILE - Documentation Technique</p>
            <p style="font-size: 0.9em; margin-top: 10px;">Document g√©n√©r√© automatiquement √† partir de l'analyse du code source</p>
        </footer>
    </div>
</body>
</html>